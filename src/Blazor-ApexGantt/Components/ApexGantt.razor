@using Microsoft.JSInterop
@using Blazor_ApexGantt.Interop
@using Blazor_ApexGantt.Models
@implements IAsyncDisposable
@inject IJSRuntime JSRuntime

<div id="@_chartId"></div>

@code {
    private string _chartId = $"gantt-{Guid.NewGuid():N}";
    private ApexGanttInterop? _interop;
    private bool _chartInitialized;
    private DotNetObjectReference<ApexGantt>? _dotNetRef;

    /// <summary>
    /// gantt chart options and configuration
    /// </summary>
    [Parameter]
    public GanttOptions Options { get; set; } = new();

    /// <summary>
    /// list of tasks to display
    /// </summary>
    [Parameter]
    public List<GanttTask>? Tasks { get; set; }

    /// <summary>
    /// event fired when a task update is initiated
    /// </summary>
    [Parameter]
    public EventCallback<TaskUpdateEventArgs> OnTaskUpdate { get; set; }

    /// <summary>
    /// event fired when a task update succeeds
    /// </summary>
    [Parameter]
    public EventCallback<TaskUpdateSuccessEventArgs> OnTaskUpdateSuccess { get; set; }

    /// <summary>
    /// event fired when a task update fails
    /// </summary>
    [Parameter]
    public EventCallback<TaskUpdateErrorEventArgs> OnTaskUpdateError { get; set; }

    /// <summary>
    /// event fired when task validation fails
    /// </summary>
    [Parameter]
    public EventCallback<TaskValidationErrorEventArgs> OnTaskValidationError { get; set; }

    /// <summary>
    /// event fired when a task bar is dragged
    /// </summary>
    [Parameter]
    public EventCallback<TaskDraggedEventArgs> OnTaskDragged { get; set; }

    /// <summary>
    /// event fired when a task bar is resized
    /// </summary>
    [Parameter]
    public EventCallback<TaskResizedEventArgs> OnTaskResized { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            _interop = new ApexGanttInterop(JSRuntime);
            await InitializeChartAsync();
        }
    }

    private async Task InitializeChartAsync()
    {
        if (_interop == null) return;

        // build chart options
        var chartOptions = BuildChartOptions();

        _chartInitialized = await _interop.InitAsync(_chartId, chartOptions, _dotNetRef);
    }

    private object BuildChartOptions()
    {
        // create options object to pass to apexgantt
        var options = new Dictionary<string, object>();

        // Basic Options
        if (Options.Height != null)
            options["height"] = Options.Height;

        if (Options.Width != null)
            options["width"] = Options.Width;

        if (!string.IsNullOrEmpty(Options.Title))
            options["title"] = Options.Title;

        if (Options.TasksContainerWidth.HasValue)
            options["tasksContainerWidth"] = Options.TasksContainerWidth.Value;

        if (!string.IsNullOrEmpty(Options.ViewMode))
            options["viewMode"] = Options.ViewMode;

        if (!string.IsNullOrEmpty(Options.Theme))
            options["theme"] = Options.Theme;

        // Visual/Appearance Options
        if (!string.IsNullOrEmpty(Options.CanvasStyle))
            options["canvasStyle"] = Options.CanvasStyle;

        if (!string.IsNullOrEmpty(Options.BarBackgroundColor))
            options["barBackgroundColor"] = Options.BarBackgroundColor;

        if (Options.BarBorderRadius.HasValue)
            options["barBorderRadius"] = Options.BarBorderRadius.Value;

        if (Options.BarMargin.HasValue)
            options["barMargin"] = Options.BarMargin.Value;

        if (!string.IsNullOrEmpty(Options.BarTextColor))
            options["barTextColor"] = Options.BarTextColor;

        if (Options.RowBackgroundColors != null && Options.RowBackgroundColors.Any())
            options["rowBackgroundColors"] = Options.RowBackgroundColors;

        // Layout Options
        if (Options.RowHeight.HasValue)
            options["rowHeight"] = Options.RowHeight.Value;

        // Interactivity Options
        if (Options.EnableToolbar.HasValue)
            options["enableToolbar"] = Options.EnableToolbar.Value;

        if (Options.EnableTaskDrag.HasValue)
            options["enableTaskDrag"] = Options.EnableTaskDrag.Value;

        if (Options.EnableTaskEdit.HasValue)
            options["enableTaskEdit"] = Options.EnableTaskEdit.Value;

        if (Options.EnableTaskResize.HasValue)
            options["enableTaskResize"] = Options.EnableTaskResize.Value;

        if (Options.EnableExport.HasValue)
            options["enableExport"] = Options.EnableExport.Value;

        if (Options.EnableResize.HasValue)
            options["enableResize"] = Options.EnableResize.Value;

        // Dependency/Arrow Options
        if (!string.IsNullOrEmpty(Options.ArrowColor))
            options["arrowColor"] = Options.ArrowColor;

        // Custom Options (applied last to allow overrides)
        if (Options.CustomOptions != null)
        {
            foreach (var kvp in Options.CustomOptions)
            {
                options[kvp.Key] = kvp.Value;
            }
        }

        // convert and add tasks in apexgantt format
        var taskList = Tasks ?? Options.Tasks;
        if (taskList != null && taskList.Any())
        {
            var formattedTasks = taskList.Select(t =>
            {
                var task = new Dictionary<string, object?>
                {
                    ["id"] = t.Id,
                    ["name"] = t.Name,
                    ["startTime"] = FormatDate(t.StartTime),
                    ["endTime"] = FormatDate(t.EndTime),
                    ["progress"] = t.Progress,
                    ["parentId"] = t.ParentId
                };

                // Add optional task properties
                if (!string.IsNullOrEmpty(t.Dependency))
                    task["dependency"] = t.Dependency;

                if (!string.IsNullOrEmpty(t.Color))
                    task["color"] = t.Color;

                if (!string.IsNullOrEmpty(t.ClassName))
                    task["className"] = t.ClassName;

                return task;
            }).ToList();

            options["series"] = formattedTasks;
        }

        return options;
    }

    private string? FormatDate(object? date)
    {
        if (date == null) return null;

        // if already a string, return as-is
        if (date is string dateStr)
            return dateStr;

        // if DateTime, convert to MM-DD-YYYY format
        if (date is DateTime dateTime)
            return dateTime.ToString("MM-dd-yyyy");

        return date.ToString();
    }

    /// <summary>
    /// called from JavaScript when task update event occurs
    /// </summary>
    [JSInvokable]
    public async Task HandleTaskUpdate(TaskUpdateEventArgs args)
    {
        if (OnTaskUpdate.HasDelegate)
        {
            await OnTaskUpdate.InvokeAsync(args);
        }
    }

    /// <summary>
    /// called from JavaScript when task update success event occurs
    /// </summary>
    [JSInvokable]
    public async Task HandleTaskUpdateSuccess(TaskUpdateSuccessEventArgs args)
    {
        if (OnTaskUpdateSuccess.HasDelegate)
        {
            await OnTaskUpdateSuccess.InvokeAsync(args);
        }
    }

    /// <summary>
    /// called from JavaScript when task update error event occurs
    /// </summary>
    [JSInvokable]
    public async Task HandleTaskUpdateError(TaskUpdateErrorEventArgs args)
    {
        if (OnTaskUpdateError.HasDelegate)
        {
            await OnTaskUpdateError.InvokeAsync(args);
        }
    }

    /// <summary>
    /// called from JavaScript when task validation error event occurs
    /// </summary>
    [JSInvokable]
    public async Task HandleTaskValidationError(TaskValidationErrorEventArgs args)
    {
        if (OnTaskValidationError.HasDelegate)
        {
            await OnTaskValidationError.InvokeAsync(args);
        }
    }

    /// <summary>
    /// called from JavaScript when task dragged event occurs
    /// </summary>
    [JSInvokable]
    public async Task HandleTaskDragged(TaskDraggedEventArgs args)
    {
        if (OnTaskDragged.HasDelegate)
        {
            await OnTaskDragged.InvokeAsync(args);
        }
    }

    /// <summary>
    /// called from JavaScript when task resized event occurs
    /// </summary>
    [JSInvokable]
    public async Task HandleTaskResized(TaskResizedEventArgs args)
    {
        if (OnTaskResized.HasDelegate)
        {
            await OnTaskResized.InvokeAsync(args);
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_interop != null && _chartInitialized)
        {
            await _interop.DestroyAsync(_chartId);
            await _interop.DisposeAsync();
        }

        _dotNetRef?.Dispose();
    }
}
